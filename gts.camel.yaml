- route:
    id: route-9f0d
    nodePrefixId: route-1d3
    from:
      id: from-0547
      uri: kamelet:postgresql-source
      parameters:
        serverName: localhost
        serverPort: '5432'
        username: postgres
        password: '123456'
        databaseName: ohayo
        query: "select \nemp_id,\ngts_id,\nemployeename,\nresource_location,\nentity,\npractice,\nbusiness_unit_name,\nCASE\nwhen upper(Resource_billability_status) = 'NON-BILLABLE' and  (upper(flag_bu) <> 'B' or flag_bu is null) then 'Practices' \nwhen upper(Resource_billability_status) = 'BILLABLE' and upper(business_unit_name) ='CORPORATE - DELIVERY & PRACTICE' then Practice\nwhen upper(entity)='SERVICE DESK' and upper(business_unit_name) ='HEALTHCARE'then 'SERVICE DESK'\n--when upper(entity) ='HTC - BPS' and upper(business_unit_name) NOT IN ('INSURANCE BFS','CONSUMER SERVICES') then 'BPO' \nWHEN upper(Refined_Resource_Status) IN ('UN-BILLED - PRACTICE BENCH','UN-BILLED - STRATEGIC BENCH','Non-Billable - IT','Un-Billed - ML/LongLeave') THEN 'Practices' \nWhen upper(Refined_Resource_Status)='NON-BILLABLE - APPROVED PROJECTS' then 'Practices'\n--When upper(Refined_Resource_Status)='NON-BILLABLE - APPROVED PROJECTS' then 'Corporate - Delivery & Practice' \nELSE business_unit_name\nEND AS businessunit,\ncustomername,\nprojectname,\nflag_bu,\nflag_ap,\nallocation_st_date,\nallocation_end_date,\ndelivery_head,\nreporting_manager,\nheadcount,\ngts_billability,\ngts_skillgroup,\npractice_core_team,\nfocused_account,\nresource_billability_status,\ncurrent_billing_startdate,\nCASE \n    WHEN UPPER(confirmed_billing_buffer) = 'C' THEN 'C'\n    ELSE ''\n    END AS confirmed_billing_buffer,\nrefined_resource_status,\nnew_bu,\nconfirmation_in_account,\nbillability_month,\nweekdate,\nproject_billing_type,\nallocation_type_name,\nproject_classification,\ndept_name,\norganization_sub_unit,\nemp_status_name,\nrow_status\nfrom\n(select *,\n\t   CASE\n            when (UPPER(emp_status_name::text) = 'TERMED' or UPPER(row_status::text) NOT IN ('DRAFT', 'RESIGNATION WITHDRAWN')) and  UPPER(entity) = 'HTC' and upper(entity) not in ('SERVICE DESK','HTC - BPS') and upper(resource_billability_status) <>'BILLABLE' THEN 'Terming - IT'\n\t\t    when upper(resource_billability_status) = 'BILLABLE' AND (UPPER(entity)<>'SERVICE DESK' and UPPER(entity)<>'HTC - BPS') and upper(project_classification) = 'CUSTOMER PROJECTS' then 'Billable - IT'\n\t\t\tWHEN UPPER(entity) <> 'HTC' and UPPER(entity) IN ('SERVICE DESK','HTC - BPS') AND UPPER(resource_billability_status) = 'BILLABLE' THEN 'Billable - BPS'\n\t\t\tWHEN upper(customername) = 'SHRI RAM CHANDRA MISSION' THEN 'Non-Billable - CSR'\n\t\t\tWHEN upper(practice)='ENTERPRISE SYSTEMS' OR upper(practice)='ENTERPRISE SYSTEM' then 'Non-Billable - Enterprise Systems'\n\t\t\tWHEN upper(flag_ap)='P' then 'Non-Billable - Approved Projects'\n            WHEN upper(confirmed_billing_buffer) IN ('C','R') or upper(business_unit_name)<>'CORPORATE - DELIVERY & PRACTICE' and (upper(projectname) like ('%TALENTPOOL%') or upper(projectname) like ('%TALENT POOL%') or upper(projectname) like ('%TALENT_POOL%')) then 'Un-Billed - BU' \n\t\t\t--WHEN upper(flag_bu)='B' and upper(resource_billability_status) <>'BILLABLE' and (upper(projectname) not like ('%TALENTPOOL%') and upper(projectname) not like ('%TALENT POOL%') and upper(projectname) not like ('%TALENT_POOL%')) and UPPER(entity)='HTC'  then 'Non-Billable - BU'\n            WHEN upper(practice)='SOC' THEN 'Non-Billable - SOC'\n            WHEN (upper(flag_bu) = 'B' AND UPPER(practice) <> 'IP SOLUTIONS')and upper(resource_billability_status) <>'BILLABLE' and (upper(projectname) not like ('%TALENTPOOL%') and upper(projectname) not like ('%TALENT POOL%') and upper(projectname) not like ('%TALENT_POOL%')) and UPPER(entity)='HTC'  then 'Non-Billable - BU'\n \t\t\t--WHEN upper(confirmed_billing_buffer)='C' or upper(business_unit_name)<>'CORPORATE - DELIVERY & PRACTICE' and (upper(projectname) like ('%TALENTPOOL%') or upper(projectname) like ('%TALENT POOL%') or upper(projectname) like ('%TALENT_POOL%')) then 'Un-Billed - BU' \n\t\t\t--WHEN UPPER(projectname)='AVAILABLE FOR DEPLOYMENT' THEN 'Un-Billed - Practice Bench'\n            WHEN upper(confirmed_billing_buffer) = 'P' or upper(projectname) = 'AVAILABLE FOR DEPLOYMENT' THEN 'Un-Billed - Practice Bench'\n\t\t\t--WHEN upper(business_unit_name)='CORPORATE - DELIVERY & PRACTICE' and (upper(projectname) like ('%TALENTPOOL%') or upper(projectname) like ('%TALENT_POOL%') or upper(projectname) like ('%TALENT POOL%'))and upper(customername) like 'HTC%' THEN 'Un-Billed - Strategic Bench'\n            WHEN UPPER(flag_ap) = 'S' or (upper(business_unit_name)='CORPORATE - DELIVERY & PRACTICE' and (upper(projectname) like ('%TALENTPOOL%') or upper(projectname) like ('%TALENT_POOL%') or upper(projectname) like ('%TALENT POOL%'))and upper(customername) like 'HTC%') THEN 'Un-Billed - Strategic Bench'            \n            WHEN projectname IN ('Maternity Leave', 'Long_Leave') THEN 'Un-Billed - ML/LongLeave' \n\t        WHEN (UPPER(emp_status_name::text) = 'TERMED' or UPPER(row_status::text) NOT IN ('DRAFT', 'RESIGNATION WITHDRAWN')) and  UPPER(entity) <> 'HTC' and upper(entity) in ('SERVICE DESK','HTC - BPS') and upper(resource_billability_status) <>'BILLABLE' THEN 'Terming - BPS'\n            WHEN UPPER(entity) <> 'HTC' and UPPER(entity) IN ('SERVICE DESK','HTC - BPS') AND UPPER(resource_billability_status) = 'NON-BILLABLE' THEN 'Non-Billable - BPS'\n            --WHEN upper(project_classification) = 'INTERNAL PROJECTS' AND (upper(flag_bu) <> 'B' or flag_bu is null) AND UPPER(projectname) <> 'AVAILABLE FOR DEPLOYMENT' AND (upper(projectname) NOT LIKE '%TALENTPOOL%' AND upper(projectname) NOT LIKE '%TALENT POOL%' AND upper(projectname) NOT LIKE '%TALENT_POOL%') THEN 'Non-Billable - IT'\n            WHEN UPPER(practice) = 'IP SOLUTIONS' OR (UPPER(flag_bu) <> 'B' OR flag_bu IS NULL) AND UPPER(projectname) <> 'AVAILABLE FOR DEPLOYMENT' AND (UPPER(projectname) NOT LIKE '%TALENTPOOL%' AND UPPER(projectname) NOT LIKE '%TALENT POOL%' AND UPPER(projectname) NOT LIKE '%TALENT_POOL%') AND UPPER(resource_billability_status) <>'BILLABLE' THEN 'Non-Billable - IT'\n\t\t\tELSE 'NULL'\nEND AS refined_resource_status,\nCASE\nWHEN COUNT(*) OVER (PARTITION BY emp_id) = SUM(CASE WHEN UPPER(gts_billability) <> 'BILLABLE' THEN 1 ELSE 0 END) OVER (PARTITION BY emp_id) THEN\nCASE\nWHEN ROW_NUMBER() OVER (PARTITION BY emp_id ORDER BY\nCASE\n        WHEN upper(project_classification) = 'CUSTOMER PROJECTS' THEN 1\n\t\tWHEN UPPER(flag_ap) = 'P' THEN 2\n\t\tWHEN upper(confirmed_billing_buffer)IN ('C','R') or upper(business_unit_name)<>'CORPORATE - DELIVERY & PRACTICE' and (upper(projectname) like ('%TALENTPOOL%') or upper(projectname) like ('%TALENT POOL%') or upper(projectname) like ('%TALENT_POOL%')) THEN 3\n\t\tWHEN (upper(flag_bu) = 'B' AND UPPER(practice) <> 'IP SOLUTIONS')and upper(resource_billability_status) <>'BILLABLE' and (upper(projectname) not like ('%TALENTPOOL%') and upper(projectname) not like ('%TALENT POOL%') and upper(projectname) not like ('%TALENT_POOL%')) and UPPER(entity)='HTC' THEN 4\t\t\t\t\n\t\tWHEN UPPER(customername) = 'SHRI RAM CHANDRA MISSION' THEN 5\n\t\tWHEN UPPER(practice) = 'ENTERPRISE SYSTEMS' OR UPPER(practice)='ENTERPRISE SYSTEM' THEN 6\n        WHEN UPPER(practice) = 'IP SOLUTIONS' OR (UPPER(flag_bu) <> 'B' OR flag_bu IS NULL) AND UPPER(projectname) <> 'AVAILABLE FOR DEPLOYMENT' AND (UPPER(projectname) NOT LIKE '%TALENTPOOL%' AND UPPER(projectname) NOT LIKE '%TALENT POOL%' AND UPPER(projectname) NOT LIKE '%TALENT_POOL%') AND UPPER(resource_billability_status) <>'BILLABLE' THEN 7\t\t\t\t\n\t\tWHEN UPPER(practice) = 'SOC' THEN 8\n        WHEN UPPER(flag_ap) = 'S' or (upper(business_unit_name)='CORPORATE - DELIVERY & PRACTICE' and (upper(projectname) like ('%TALENTPOOL%') or upper(projectname) like ('%TALENT_POOL%') or upper(projectname) like ('%TALENT POOL%'))and upper(customername) like 'HTC%') THEN 9\n\t\tWHEN upper(confirmed_billing_buffer) = 'P' or upper(projectname) = 'AVAILABLE FOR DEPLOYMENT' THEN 10\n\t\tWHEN UPPER(projectname) IN ('MATERNITY LEAVE', 'LONG_LEAVE') THEN 11\n\t\tELSE 12\nEND\n) = 1 THEN 1\nELSE 0\n\tEND\n\t   WHEN (SUM(CASE WHEN UPPER(gts_billability) = 'BILLABLE' THEN 1 ELSE 0 END) OVER (PARTITION BY emp_id) > 1\n\t   AND RANK() OVER (PARTITION BY emp_id ORDER BY\n\t   CASE WHEN UPPER(gts_billability) = 'BILLABLE' AND UPPER(project_classification) = 'CUSTOMER PROJECTS' THEN 0 ELSE 1 END,\n\t\tallocation_st_date::date ASC,\n\t\tprojectname ASC,\n\t\tcustomername ASC) = 1\n\t  )\n\tTHEN 1\n\tELSE\n\tCASE\n\tWHEN UPPER(gts_billability) = 'BILLABLE' AND (UPPER(project_classification) = 'CUSTOMER PROJECTS' OR UPPER(project_classification) = 'INTERNAL PROJECTS')\n\t\t\t AND COUNT(*) OVER (PARTITION BY emp_id, UPPER(gts_billability)) = 1\n\t\t\tOR\n\t\t\t(UPPER(gts_billability) = 'BILLABLE' AND UPPER(flag_ap) = 'P'\n\t\t\t AND COUNT(*) OVER (PARTITION BY emp_id, UPPER(gts_billability)) = 1)\n\t\tTHEN 1\n\t\tELSE 0\n\tEND\nEND AS headcount\nfrom (SELECT *,\n\t\t  CASE\n\t\t\tWHEN SUM(CASE WHEN UPPER(gts_billability) = 'BILLABLE' THEN 1 ELSE 0 END) OVER (PARTITION BY emp_id ) > 0 THEN 'Billable'\n\t\t\tELSE 'Non-Billable'\n\t\tEND AS resource_billability_status\nFROM\n(SELECT DISTINCT\n\t\temp.emp_id AS emp_id,\n\t\temp.gts_emp_id AS gts_id,\n\t\temp.name AS employeename,\n\t\tpmo.company,\n\t\tpmo.business_unit_name,\n\t\temp.organization_sub_unit,\n\t\tCASE\n\t\t\tWHEN upper(emp.company) IN ('HTC GLOBAL SERVICES INC') THEN 'US'\n\t\t\tELSE 'Non-US'\n\t\tEND AS resource_location,\n\t\tCASE\n\t\t\tWHEN upper(pmo.company) IN ('HTC GLOBAL SERVICES INC')\n\t\t\t\tAND upper(pmo.business_unit_name) = 'HEALTHCARE'\n\t\t\t\tAND upper(emp.organization_sub_unit) = 'BPO' THEN 'SERVICE DESK'\n\t\t\tWHEN upper(pmo.project_name) LIKE 'BPS%' or upper(pmo.project_name) LIKE 'ITES%'\n\t\t\t\t THEN 'HTC - BPS'\n\t\t\tELSE 'HTC'\n\t\tEND AS entity,\n\t\temp.organization_sub_unit AS practice,\n\t\tpmo.customer_name as customername,\n\t\tpmo.project_name as projectname,\n\t\tTO_CHAR(pmo.member_start_date::TIMESTAMP WITH TIME ZONE, 'mm-dd-yyyy') AS allocation_st_date,\n\t\tTO_CHAR(pmo.member_end_date::TIMESTAMP WITH TIME ZONE, 'mm-dd-yyyy') AS allocation_end_date,\n\t\tpmo.delivery_head as delivery_head,\n\t\tpmo.project_manager AS reporting_manager,\n\t\tCASE \n            WHEN upper(pmo.allocation_type_name) = 'BILLABLE' AND upper(pmo.project_classification) = 'INTERNAL PROJECTS' THEN 'Non-Billable'\n            WHEN upper(pmo.allocation_type_name) = 'BILLABLE' THEN 'Billable'\n\t\t\tWHEN upper(pmo.allocation_type_name) = 'NON-BILLABLE' AND upper(pmo.project_billing_type) = 'FIXED PRICE' AND upper(pmo.project_classification) = 'CUSTOMER PROJECTS' THEN 'Billable'\n\t\t\tELSE 'Non-Billable'\n\t\tEND AS gts_billability,\n\t\t--CASE\n\t\t\t--WHEN upper(project_billing_type)='FIXED PRICE' and upper(project_classification)='CUSTOMER PROJECTS' THEN 'Billable'\n\t\t\t--ELSE 'Non-Billable'\n\t\t--END AS gts_billability,\n\t\tpmo.core_skill_category AS gts_skillgroup,\n\t\t'' AS practice_core_team,--need clarification\n\t\tCASE \n\t\t\tWHEN upper(pmo.customer_name)=upper(FL.customer_name) IS NOT NULL THEN FL.focus_account\n\t\t\tELSE 'Others'\n\t\tEND AS focused_account,\n\t\t--CASE\n\t\t\t--WHEN SUM(CASE WHEN UPPER(pmo.allocation_type_name) = 'BILLABLE' THEN 1 ELSE 0 END) OVER (PARTITION BY pmo.emp_id ) > 0 THEN 'Billable'\n\t\t\t--ELSE 'Non-Billable'\n\t\t--END AS resource_billability_status,\n\t\tcf.current_billing_start_date AS current_billing_startdate,\n\t\tcf.new_bu AS new_bu,\n\t\tcf.confirmation_in_account AS confirmation_in_account,\n\t\t'' AS billability_month,\n\t\tpmo.allocation_type_name as allocation_type_name,\n\t\tTO_CHAR(CURRENT_DATE, 'DD-Mon-YY') AS weekdate,\n\t\tbu.flag as flag_bu,\n\t\tap.flag as flag_ap,\n\t\tpmo.project_classification,\n\t\tupper(emp.emp_status_name) as emp_status_name,\n\t\tUPPER(row.status) as row_status,\n\t\tpmo.allocation_status_name,\n\t\tpmo.project_billing_type,\n\t\tupper(emp.dept_name) as dept_name,\n        cf.confirmed_billing_flag as confirmed_billing_buffer\nFROM \ngts.global_emp_details emp \nLEFT JOIN  \ngts.gts_project_allocation_report_pmo pmo ON pmo.global_employee_id = emp.gts_emp_id \nLEFT JOIN\n\n(select tableA.global_emp_id, tableA.status, tableA.initiated_date from gts.ems_employee_exit_report tableA \ninner join \n(SELECT global_emp_id, MAX(initiated_date) as max_initiated_date\nFROM gts.ems_employee_exit_report where status not in ('DRAFT', 'RESIGNATION WITHDRAWN') group by global_emp_id) tableB \non tableA.global_emp_id = tableB.global_emp_id and tableA.initiated_date = tableB.max_initiated_date) as  row\non row.global_emp_id=emp.gts_emp_id\n\nLEFT JOIN\ngts.Confirmed_Lookup cf ON cf.gts_id=emp.gts_emp_id\nLEFT JOIN\ngts.businessunit_approvedproject bu ON UPPER(bu.business_unit) = UPPER(pmo.business_unit_name)\nLEFT JOIN\ngts.businessunit_approvedproject ap ON UPPER(ap.approved_projects) = UPPER(pmo.project_name)\nLEFT JOIN \ngts.focused_account_lookup FL on UPPER(FL.customer_name)=UPPER(pmo.customer_name)\nWHERE\nupper(allocation_status_name)='ACTIVE' \nAND(((UPPER(pmo.project_name) LIKE 'PRACTICE%' OR UPPER(pmo.project_name) LIKE 'INTERNAL%')\n    AND (UPPER(pmo.customer_name) = 'CIBER INTERNAL NONBILL'\n\t\tAND UPPER(pmo.company) = 'HTC GLOBAL SERVICES INC' )) OR (UPPER(pmo.project_name) NOT LIKE 'PRACTICE%' \n\t\t\tAND UPPER(pmo.project_name) NOT LIKE 'INTERNAL%'))\nAND upper(emp.emp_status_name)='CURRENT EMPLOYEE' \nAND upper(emp.dept_name) IN ('DELIVERY','CIO') \nAND upper(emp.emploment_type) NOT IN ('OUTSOURCED','INTERNSHIP') AND upper(emp.organization_sub_unit) NOT IN ('QUALITY','ITMR','CORPORATE EXECUTIVE','TRAINING')\nAND emp.emp_id not in (select emp_id from gts.Designation_Exclusion)\n)exc\n)resource_status\n)BU\n--where\n--headcount=1\n\n\n\n"
      steps:
        - to:
            id: to-7b76
            uri: kamelet:postgresql-sink
            parameters:
              serverName: localhost
              serverPort: '5432'
              username: postgres
              password: '123456'
              query: |-
                INSERT INTO public.accounts (
                    emp_id,
                    gts_id,
                    employeename,
                    resource_location,
                    entity,
                    practice,
                    businessunit,
                    customername,
                    projectname,
                    allocation_st_date,
                    allocation_end_date,
                    delivery_head,
                    reporting_manager,
                    headcount,
                    gts_billability,
                    gts_skillgroup,
                    practice_core_team,
                    focused_account,
                    resource_billability_status,
                    current_billing_startdate,
                    confirmed_billing_buffer,
                    refined_resource_status,
                    new_bu,
                    confirmation_in_account,
                    billability_month,
                    weekdate,
                    comparison_period
                ) VALUES (
                    :#emp_id,
                    :#gts_id,
                    :#employeename,
                    :#resource_location,
                    :#entity,
                    :#practice,
                    :#businessunit,
                    :#customername,
                    :#projectname,
                    :#allocation_st_date,
                    :#allocation_end_date,
                    :#delivery_head,
                    :#reporting_manager,
                    :#headcount,
                    :#gts_billability,
                    :#gts_skillgroup,
                    :#practice_core_team,
                    :#focused_account,
                    :#resource_billability_status,
                    :#current_billing_startdate,
                    :#confirmed_billing_buffer,
                    :#refined_resource_status,
                    :#new_bu,
                    :#confirmation_in_account,
                    :#billability_month,
                    :#weekdate,
                    :#comparison_period
                )
              databaseName: ohayo
